<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fashionizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Fira+Mono" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="/index.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="/results.css" />
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.13.4/dist/tf.min.js"></script>
</head>

<body>
    <div id="default">
        <h1 id="Fashionizer">Fashionizer</h1>
        <div id="image-container">
            <canvas id="image-canvas"></canvas>
        </div>
        <div id="price-container">
            <h2>How old is the fashion item?</h2>
            <p>years</p>
            <select id="years">
                <option>0</option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
                <option>10</option>
            </select>

            <p>months</p>
            <select id="months">
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
                <option>10</option>
                <option>11</option>
            </select>

            <button onclick="getPrice()">Get price</button>
        </div>
    </div>
    </br>
    <script>
        async function classify() {
            let classes = ['T-shirt/top', 'Trouser', 'Pullover', 'Dress', 'Coat', 'Sandal', 'Shirt', 'Sneaker', 'Bag', 'Ankle boot'];

            console.log("loading model...");
            let model = await tf.loadModel('https://still-ocean-95207.herokuapp.com/model');
            console.log("done");

            console.log("getting image...");
            let canvas = document.getElementById('image-canvas');
            let ctx = canvas.getContext('2d');
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height - 100);
            console.log("done");

            console.log("image to pixels...");
            let image = tf.fromPixels(imageData);
            image.print();
            console.log("FROM PIXELS AFTER NORMALISATION");
            console.log("done");

            console.log("resizing...");
            image = image.mean(2);
            let normalization_tensor = tf.fill([300, 300], 255.0);
            let normalized_image = tf.div(image, normalization_tensor);
            console.log("NORMALIZED IMAGE:: ");
            normalized_image.print();
            image = image.expandDims(2);
            image = tf.image.resizeBilinear(image, [28, 28]);
            image = image.squeeze([2]);
            image = image.expandDims(0);

            let predictions = model.predict(image).as1D();
            console.log("predictions: ");
            predictions.print();
            let prediction = tf.argMax(predictions, 0);
            //prediction = prediction.get(0);

            console.log("prediction: " + prediction);
            let result = 'Clothe detected: ' + classes[prediction];
            resultData = result.dataSync();
            result = resultData[0];
            let div = document.getElementById('image-container');
            div.appendChild(document.createTextNode(result));

            return null;
        }

        function draw() {
            let canvas = document.getElementById('image-canvas');
            let ctx = canvas.getContext('2d');
            let img = new Image();
            let ios = !!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform);
            img.onload = function () {
                canvas.height = (canvas.width / 3) * 4;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                if (ios) {
                    ctx.rotate(Math.PI / 2);
                }
                classify();
            };
            img.src = 'https://still-ocean-95207.herokuapp.com/img';
        }
        draw();
        //classify();
    </script>
</body>

</html>